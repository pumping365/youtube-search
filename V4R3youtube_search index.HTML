<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube ê²€ìƒ‰ê¸° Pro++ v4 (R2 BASE Step1)</title>
  <style>
    :root { --bd:#ddd; --bg:#f7f7f7; --muted:#666; --card:#fff; --shadow: 0 6px 18px rgba(0,0,0,.06); --topbar-h: 72px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; background:#fff; }
    h2 { margin: 0 0 10px 0; }
    .muted { color: var(--muted); font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid var(--bd); border-radius:999px; background:#fff; }
    .small { font-size: 12px; }
    input, select, button, textarea { padding:8px; border:1px solid var(--bd); border-radius:12px; font-family: inherit; }
    textarea { resize: vertical; min-height: 42px; }
    button { cursor:pointer; background:#fff; }
    button.primary { background: var(--bg); font-weight:900; }
    button.preset { font-weight:900; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    /* âœ… ìƒë‹¨ë°”(ë²„íŠ¼ ë°°ì¹˜ ì •ë¦¬) */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 1200;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      border:1px solid var(--bd);
      border-radius: 16px;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .toprow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;

  /* ë°•ìŠ¤(ì‚¬ê°) ì œê±° */
  padding:0;
  border:0;
  border-radius:0;
}
.group{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding:6px; border:none; border-radius:14px; }

    .right { margin-left:auto; }
    .tabbtn { padding: 10px 14px; border:1px solid var(--bd); background:#fff; border-radius:12px; cursor:pointer; font-weight:900; }
    .tabbtn.active { background: var(--bg); }

    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .panel { display:none; border:1px solid var(--bd); border-radius:16px; padding:12px; background:#fff; box-shadow: var(--shadow); }
    .panel.active { display:block; }

    .layout { display:block; } /* âœ… ë³¸ë¬¸ 1ì—´ ìœ ì§€ */

    .tablewrap { overflow:auto; max-height: 62vh; margin-top: 12px; border:1px solid var(--bd); border-radius:14px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--bd); padding:10px; vertical-align:top; }
    th { position: sticky; top:0; background: var(--bg); z-index:1; text-align:left; }

    .link { word-break: break-all; }
    .wmax { max-width: 560px; }
    .thumb { width: 120px; height: 68px; object-fit: cover; border-radius: 10px; border: 1px solid var(--bd); background: var(--bg); }
    .avatar { width: 44px; height: 44px; border-radius: 999px; object-fit: cover; border: 1px solid var(--bd); background: var(--bg); }
    .clickable { cursor: pointer; }
    .clickable:hover { background: #fafafa; }
    .toolbar { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .status { margin-left: 6px; }
    .pill { padding:6px 10px; border:1px solid var(--bd); border-radius:999px; background:#fff; font-size:12px; }
    .chip { padding:6px 10px; border:1px solid var(--bd); border-radius:999px; background:#fff; font-size:12px; }
    .chk { display:flex; align-items:center; gap:6px; }

    .divider { height:1px; background: var(--bd); margin: 12px 0; }
    .sectionTitle { font-weight:900; margin-top: 10px; }
    .miniBtn { padding:6px 10px; border-radius:999px; font-size:12px; }

    /* âœ… í…Œì´ë¸” ì¸ë„¤ì¼ í¬ê²Œ */
    #v_tbl img.thumb{ width: 240px !important; height: 135px !important; object-fit: cover !important; border-radius: 10px; display:block; }
    #v_tbl th:nth-child(2), #v_tbl td:nth-child(2){ width:260px !important; min-width:260px !important; }
    #v_tbl td{ padding-top:4px; padding-bottom:6px; vertical-align:middle; }
    #v_tbl td:nth-child(3) b{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

    /* âœ… ë³„í‘œ ì €ì¥ ë²„íŠ¼ ì„¸ë¡œ */
    #v_tbl button.miniBtn{
      width:42px; height:96px; padding:6px 4px; border-radius:10px; font-weight:700; cursor:pointer;
      border:1px solid #aaa; background:#fff;
      writing-mode: vertical-rl; text-orientation: upright;
      display:flex; align-items:center; justify-content:center;
      line-height:1.0;
    }
    #v_tbl button.miniBtn.primary{ background:#ffe066; border:1px solid #d4b100; color:#000; }
    #v_tbl td:first-child{ width:52px; text-align:center; }

    /* âœ… ì±„ë„ë¶„ì„ ë“œë¡œì–´(íŒì—…) */
    .drawer{
      position: fixed;
      top: 12px;
      right: 12px;
      width: min(460px, 92vw);
      height: calc(100vh - 24px);
      background:#fff;
      border:1px solid var(--bd);
      border-radius: 18px;
      box-shadow: -10px 0 24px rgba(0,0,0,.12);
      transform: translateX(110%);
      transition: transform .18s ease;
      z-index: 2000;
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }
    .drawer.open{ transform: translateX(0); }
    .drawer-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px; border-bottom:1px solid #eef0f3; background:#fff;
    }
    .drawer-head .title{ font-weight:900; font-size:14px; }
    .drawer-body{ flex:1; overflow:auto; padding: 10px; }

    .drawer-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,.22);
      z-index: 1990; display:none;
    }
    .drawer-backdrop.show{ display:block; }

    .icon-btn{
      width:36px; height:36px; border-radius:10px;
      border:1px solid var(--bd); background:#fff; cursor:pointer;
    }
    .icon-btn:hover{ background:#f6f7f9; }

    /* âœ… ë¶„ì„ íŒ¨ë„ ë‚´ë¶€(ê¸°ì¡´ analyzer) */
    .analyzer { border:1px solid var(--bd); border-radius: 16px; padding: 12px; background: var(--card); box-shadow: var(--shadow); }
    .anHeader { display:flex; gap:10px; align-items:center; }
    .anTitle { font-weight:900; font-size: 15px; margin:0; }
    .anSub { font-size:12px; color: var(--muted); }
    .anGrid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .kpi { border:1px solid var(--bd); border-radius:14px; padding:10px; background:#fff; }
    .kpi .label { font-size:12px; color: var(--muted); }
    .kpi .value { font-weight:900; font-size: 16px; margin-top:4px; }
    .anList { margin-top: 10px; border:1px solid var(--bd); border-radius:14px; overflow:hidden; }
    .anItem { display:flex; gap:10px; padding:10px; border-bottom:1px solid var(--bd); background:#fff; }
    .anItem:last-child { border-bottom:none; }
    .anItem img { width: 96px; height: 54px; object-fit:cover; border-radius:10px; border:1px solid var(--bd); background: var(--bg); }
    .anItem .t { font-weight:900; font-size: 13px; line-height: 1.2; }
    .anItem .m { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .anFooter { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .hint { font-size:12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }

    /* ì¦ê²¨ì°¾ê¸° */
    .favBox { margin-top:12px; border:1px solid var(--bd); border-radius:14px; overflow:hidden; }
    .favBody { max-height: 260px; overflow:auto; }
    .favItem { display:flex; gap:10px; padding:10px; border-bottom:1px solid var(--bd); background:#fff; }
    .favItem:last-child { border-bottom:none; }
    .favItem .t { font-weight:900; font-size: 13px; line-height:1.2; }
    .favItem .m { font-size:12px; color: var(--muted); margin-top:4px; }
    .favItem .actions { margin-left:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
/* âœ… ì±„ë„ë¶„ì„(ë‹ë³´ê¸°) ë²„íŠ¼ í¬ê²Œ */
.anBtn{
  width: 54px;
  height: 44px;
  border-radius: 12px;
  border: 1px solid var(--bd);
  background: #fff;
  font-size: 20px;
  font-weight: 900;
  cursor: pointer;
}
.anBtn:hover{ background: #f6f7f9; }
/* âœ… ë¶„ì„ íŒ¨ë„ URL ì¤„ë°”ê¿ˆ/ë„˜ì¹¨ ë°©ì§€ */
#an_sub, #an_sub a.anLink{
  display:block;
  max-width:100%;
  overflow-wrap:anywhere;   /* ê¸´ URLë„ ê°•ì œ ì¤„ë°”ê¿ˆ */
  word-break:break-word;
  line-height:1.25;
  font-size:12px;
}
#an_sub a.anLink{
  text-decoration: underline;
}
/* ìƒë‹¨ í—¤ë”(ì œëª©+ì„¤ëª…) */
.brand{
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-right:12px;
  min-width:260px;
}

.appTitle{
  margin:0;
  font-size:20px;
  line-height:1.1;
}

.appSub{
  margin:0;
  font-size:12px;
  opacity:0.75;
}

/* í•œ ì¤„ì— ì˜ˆì˜ê²Œ */
.toprow{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

/* ê¸°ì¡´ì— ì“°ì‹œë˜ ìŠ¤í˜ì´ì„œ(right) ìœ ì§€ */
.right{ flex:1; }
.toprow{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.brand{min-width:320px;}
.right{flex:1;}
.group{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
.brand{display:flex; flex-direction:column; gap:2px;}
 .chanActions { white-space: nowrap; }
/* ====== ë²„íŠ¼ UIë¥¼ "ì‚¬ì§„ ëŠë‚Œ"ìœ¼ë¡œ ====== */

/* ìƒë‹¨ ê·¸ë£¹ ì ì„  ë°•ìŠ¤ ì—†ì• ê³  ê°„ê²©ë§Œ ìœ ì§€ */
.topbar .group{
  border: 0 !important;
  padding: 0 !important;
  gap: 8px !important;
}

/* ê³µí†µ ë²„íŠ¼(íƒ­/í”„ë¦¬ì…‹/ì•¡ì…˜) */
.topbar button{
  border: 1px solid #d6dbe3;
  border-radius: 10px;
  background: #f3f6fb;
  padding: 8px 12px;
  font-weight: 800;
  box-shadow: 0 1px 0 rgba(0,0,0,.03);
}
.topbar button:hover{ filter: brightness(0.98); }

/* íƒ­(ì˜ìƒ/ì±„ë„) */
.tabbtn{
  background: #eaf2ff;
}
.tabbtn.active{
  background: #dbeaff;
  border-color: #bcd4ff;
}

/* ëŒ€ë¶„ë¥˜(ë“œë¡ /ë¶€ë™ì‚°/PET/í•´ì™¸) = ìì£¼ì“°ëŠ” ì›í´ë¦­ ë²„íŠ¼ ëŠë‚Œ */
button.preset{
  background: #eaf7ff;
  border-color: #bfe3f6;
}

/* ìš°ì¸¡ ì•¡ì…˜(ì €ì¥/ì—´ê¸°/ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°) */
#btnSaveSettings, #btnLoadSettings, #btnExportSettings, #btnImportSettings{
  background: #eef5ff;
}

/* 'â€¦' ë²„íŠ¼ì´ ë„ˆë¬´ íŠ€ë©´ ì‚´ì§ë§Œ */
.topbar button.more{
  background: #f6f7f9;
}
/* âœ… ìƒë‹¨ë°” ì ì„ (ê·¸ë£¹ ë°•ìŠ¤) ê°•ì œ ì œê±°: ìµœí›„ë°©ì–´ */
.topbar .group{
 border:0 !important;
 border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}


 </style>
</head>

<body>
    <div class="topbar">
  <div class="toprow">

        <div class="brand">
      <h2 class="appTitle">YouTube ê²€ìƒ‰ê¸° Pro++ v4 Ultimate</h2>
      <div class="muted appSub">âœ… ì¦ê²¨ì°¾ê¸° í´ë” ë¶„ë¥˜ Â· ... Â· CSV/JSON</div>
    </div>

    <div class="group">
      <button id="tabVideo" class="tabbtn active">ğŸ¬ ì˜ìƒ</button>
      <button id="tabChannel" class="tabbtn">ğŸ“º ì±„ë„</button>
    </div>
    <div class="group">
    <button class="preset" id="p_drone">ğŸ§° ë“œë¡ </button>
  <button class="preset" id="p_realestate">ğŸ  ë¶€ë™ì‚°</button>
  <button class="preset" id="p_pet">ğŸ¶ PET</button>
  <button class="preset" id="p_global">ğŸŒ í•´ì™¸</button>
</div>
...
    <span class="right"></span>
    <div class="group">
        <button id="btnSaveSettings">ğŸ’¾ ì €ì¥</button>
      <button id="btnLoadSettings">ğŸ“‚ ì—´ê¸°</button>
      <button id="btnExportSettings">â¬‡ï¸ ë‚´ë³´ë‚´ê¸°</button>
      <button id="btnImportSettings">â¬†ï¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

  </div>
</div>


  <dialog id="dlgImport">
    <div class="row" style="margin-bottom:8px;">
      <h3 style="margin:0;">ì„¤ì • JSON ë¶ˆëŸ¬ì˜¤ê¸°</h3>
      <span class="right"></span>
      <button id="dlgClose">ë‹«ê¸°</button>
    </div>
    <div class="muted">ì•„ë˜ ì¹¸ì— JSONì„ ë¶™ì—¬ë„£ê³  â€œì ìš©â€ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    <textarea id="importJson" style="width:100%; margin-top:10px;" rows="10" placeholder='{"video":{...},"channel":{...}}'></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="dlgApply" class="primary">ì ìš©</button>
      <span id="dlgStatus" class="muted"></span>
    </div>
  </dialog>

  <div class="layout">
    <section id="panelVideo" class="panel active">
      <div class="row">
        <input id="v_q" placeholder="ì˜¤ëŠ˜ì˜ í•« ì˜ìƒ (ì˜ˆ: ì˜¤ëŠ˜ í•«ì˜ìƒ, trending, ì‡¼ì¸  ì¸ê¸°)" />

        <input id="v_or" placeholder="OR í‚¤ì›Œë“œ (ì‰¼í‘œ: ìê²©ì¦,êµìœ¡)" size="28" />
        <input id="v_ex" placeholder="ì œì™¸ í‚¤ì›Œë“œ (ì‰¼í‘œ: ê´‘ê³ ,í˜‘ì°¬)" size="24" />

        <select id="v_order">
          <option value="relevance">ê´€ë ¨ë„</option>
          <option value="date">ìµœì‹ ìˆœ(API)</option>
          <option value="viewCount">ì¡°íšŒìˆ˜ìˆœ(API)</option>
          <option value="rating">í‰ì ìˆœ(API)</option>
          <option value="title">ì œëª©ìˆœ(API)</option>
        </select>

        <select id="v_region"></select>

        <select id="v_maxResults">
          <option value="10">10ê°œ</option>
          <option value="20" selected>20ê°œ</option>
          <option value="30">30ê°œ</option>
          <option value="50">50ê°œ</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px;">
        <span class="badge">ê¸°ê°„</span>
        <label class="small">ì‹œì‘</label>
        <input id="v_after" type="date" />
        <label class="small">ì¢…ë£Œ</label>
        <input id="v_before" type="date" />
        <span class="muted">â€» ë¹„ìš°ë©´ ì „ì²´ê¸°ê°„</span>

        <span class="right"></span>
        <button id="v_btnSearch" class="primary">ê²€ìƒ‰</button>
        <button id="v_btnPrev" disabled>ì´ì „</button>
        <button id="v_btnNext" disabled>ë‹¤ìŒ</button>
        <button id="v_btnCsv" disabled>CSV ì €ì¥</button>
        <span id="v_status" class="muted status"></span>
      </div>

      <div class="toolbar">
        <select id="v_sortLocal">
          <option value="score_desc">[ë­í‚¹] ì ìˆ˜ â†“</option>
          <option value="viewCount_desc">ì¡°íšŒìˆ˜ â†“</option>
          <option value="subscribers_desc">êµ¬ë…ììˆ˜ â†“</option>
          <option value="published_desc">ì—…ë¡œë“œ ìµœì‹  â†“</option>
        </select>

        <span class="chip">í•„í„°</span>
        <label class="small">ìµœì†Œ ì¡°íšŒìˆ˜</label>
        <input id="v_minViews" type="number" min="0" step="1000" placeholder="ì˜ˆ: 100000" style="width:140px;" />
        <label class="small">ìµœì†Œ êµ¬ë…ì</label>
        <input id="v_minSubs" type="number" min="0" step="1000" placeholder="ì˜ˆ: 5000" style="width:140px;" />
        <label class="chk small"><input id="v_dedupeChannel" type="checkbox" checked /> ì±„ë„ ì¤‘ë³µì œê±°</label>

        <span class="right"></span>
        <button id="v_applyFilters" class="primary">í•„í„° ì ìš©</button>

        <span class="pill">ì ìˆ˜ = ì¡°íšŒìˆ˜ + êµ¬ë…ì + ìµœì‹  ì—…ë¡œë“œ ë³´ì •</span>
      </div>

      <div class="tablewrap">
        <table id="v_tbl">
          <thead>
            <tr>
              <th style="min-width:60px;">â˜…</th>
              <th style="min-width:260px;">ì¸ë„¤ì¼</th>
              <th style="min-width:260px;">ì˜ìƒ</th>
              <th style="min-width:110px;">ì—…ë¡œë“œì¼</th>
              <th style="min-width:90px;">ì¡°íšŒìˆ˜</th>
              <th style="min-width:110px;">êµ¬ë…ììˆ˜</th>
              <th style="min-width:80px;">êµ­ê°€</th>
              <th style="min-width:90px;">ì ìˆ˜</th>
              <th style="min-width:220px;">ì±„ë„ë¶„ì„</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="hint">âœ… ì±„ë„ í´ë¦­ â†’ ì˜¤ë¥¸ìª½ ë¶„ì„ íŒì—… í‘œì‹œ / âœ… â˜… ëˆ„ë¥´ë©´ ì¦ê²¨ì°¾ê¸° ì €ì¥(í´ë” ìë™ ë¶„ë¥˜)</div>
    </section>

    <section id="panelChannel" class="panel">
      <div class="row">
        <input id="c_q" placeholder="ì˜¤ëŠ˜ ì¸ê¸° ì±„ë„ (ì˜ˆ: ë‰´ìŠ¤, ê²½ì œ, ë“œë¡ )" />
        <input id="c_or" placeholder="OR í‚¤ì›Œë“œ (ì‰¼í‘œ: êµìœ¡,ìê²©ì¦)" size="28" />
        <input id="c_ex" placeholder="ì œì™¸ í‚¤ì›Œë“œ (ì‰¼í‘œ: ê´‘ê³ ,í˜‘ì°¬)" size="24" />

        <select id="c_order">
          <option value="relevance">ê´€ë ¨ë„</option>
          <option value="date">ìµœì‹  ë°œê²¬(API)</option>
          <option value="videoCount">ì˜ìƒ ìˆ˜ ë§ì€ ìˆœ(API)</option>
          <option value="title">ì œëª©ìˆœ(API)</option>
        </select>

        <select id="c_region"></select>

        <select id="c_maxResults">
          <option value="10">10ê°œ</option>
          <option value="20" selected>20ê°œ</option>
          <option value="30">30ê°œ</option>
          <option value="50">50ê°œ</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px;">
        <span class="badge">ê¸°ê°„</span>
        <label class="small">ì‹œì‘</label>
        <input id="c_after" type="date" />
        <label class="small">ì¢…ë£Œ</label>
        <input id="c_before" type="date" />
        <span class="muted">â€» ì±„ë„ ê²€ìƒ‰ ê¸°ê°„ì€ â€œê²€ìƒ‰ ê²°ê³¼â€ ì˜í–¥</span>

        <span class="right"></span>
        <button id="c_btnSearch" class="primary">ê²€ìƒ‰</button>
        <button id="c_btnPrev" disabled>ì´ì „</button>
        <button id="c_btnNext" disabled>ë‹¤ìŒ</button>
        <button id="c_btnCsv" disabled>CSV ì €ì¥</button>
        <span id="c_status" class="muted status"></span>
      </div>

      <div class="toolbar">
        <select id="c_sortLocal">
          <option value="score_desc">[ë­í‚¹] ì ìˆ˜ â†“</option>
          <option value="subscribers_desc">êµ¬ë…ììˆ˜ â†“</option>
          <option value="views_desc">ì´ì¡°íšŒìˆ˜ â†“</option>
          <option value="created_desc">ì±„ë„ìƒì„± ìµœì‹  â†“</option>
        </select>

        <span class="chip">í•„í„°</span>
        <label class="small">ìµœì†Œ êµ¬ë…ì</label>
        <input id="c_minSubs" type="number" min="0" step="1000" placeholder="ì˜ˆ: 10000" style="width:140px;" />
        <label class="small">ìµœì†Œ ì´ì¡°íšŒìˆ˜</label>
        <input id="c_minViews" type="number" min="0" step="1000" placeholder="ì˜ˆ: 500000" style="width:140px;" />

        <span class="right"></span>
        <button id="c_applyFilters" class="primary">í•„í„° ì ìš©</button>

        <span class="pill">ì ìˆ˜ = êµ¬ë…ì + ì´ì¡°íšŒìˆ˜(ê°€ì¤‘)</span>
      </div>

      <div class="tablewrap">
        <table id="c_tbl">
          <thead>
            <tr>
              <th style="min-width:80px;">â˜…</th>
              <th style="min-width:110px;">ì±„ë„</th>
              <th style="min-width:110px;">êµ¬ë…ììˆ˜</th>
              <th style="min-width:110px;">ì´ì¡°íšŒìˆ˜</th>
              <th style="min-width:110px;">ì´ì˜ìƒìˆ˜</th>
              <th style="min-width:110px;">ìƒì„±ì¼</th>
              <th style="min-width:80px;">êµ­ê°€</th>
              <th style="min-width:90px;">ì ìˆ˜</th>
              <th style="min-width:260px;">ì±„ë„ë¶„ì„</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="hint">âœ… ì¤„ í´ë¦­ â†’ ì˜¤ë¥¸ìª½ ë¶„ì„ íŒì—… í‘œì‹œ / âœ… â˜… ëˆ„ë¥´ë©´ ì¦ê²¨ì°¾ê¸° ì €ì¥(í´ë” ìë™ ë¶„ë¥˜)</div>
    </section>
  </div>

  <!-- âœ… ë¶„ì„ ë“œë¡œì–´(íŒì—…) -->
  <div id="anBackdrop" class="drawer-backdrop" onclick="closeAnalyzerDrawer()"></div>

  <aside id="anDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="title">ì±„ë„ ë¶„ì„</div>
      <button class="icon-btn" onclick="closeAnalyzerDrawer()" title="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="drawer-body">
      <div class="analyzer" id="analyzer">
        <div class="anHeader">
          <img id="an_avatar" class="avatar" alt="" />
          <div style="min-width:0;">
            <div class="anTitle" id="an_title">ì±„ë„ ë¶„ì„ íŒ¨ë„</div>
            <div class="anSub" id="an_sub">ì±„ë„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="anGrid">
          <div class="kpi"><div class="label">êµ¬ë…ììˆ˜</div><div class="value" id="an_subs">-</div></div>
          <div class="kpi"><div class="label">ì´ì¡°íšŒìˆ˜</div><div class="value" id="an_views">-</div></div>
          <div class="kpi"><div class="label">ì´ì˜ìƒìˆ˜</div><div class="value" id="an_videos">-</div></div>
          <div class="kpi"><div class="label">ì±„ë„ ìƒì„±ì¼</div><div class="value" id="an_created">-</div></div>
        </div>

        <div class="anGrid" style="margin-top:8px;">
          <div class="kpi"><div class="label">ìµœê·¼ ì—…ë¡œë“œ ë‚ ì§œ</div><div class="value" id="an_latest_date">-</div></div>
          <div class="kpi">
            <div class="label">ì„±ê³¼ì§€í‘œ(íš¨ìœ¨)</div>
            <div class="value" id="an_eff">-</div>
            <div class="muted small" id="an_eff_sub"></div>
          </div>
        </div>

        <div class="anFooter">
          <button id="an_open" disabled>ì±„ë„ ì—´ê¸°</button>
          <button id="an_latest" disabled class="primary">ìµœì‹  ì˜ìƒ 10ê°œ ê°±ì‹ </button>
          <button id="an_fav" disabled>â˜… ì¦ê²¨ì°¾ê¸° ì¶”ê°€</button>
        </div>

        <div class="hint" id="an_desc"></div>

        <div style="margin-top:10px;">
          <div class="badge">ìµœì‹  ì˜ìƒ</div>
          <span class="muted" id="an_list_status"></span>
        </div>
        <div class="anList" id="an_list"></div>

        <div class="divider"></div>

        <div class="sectionTitle">â˜… ì¦ê²¨ì°¾ê¸° í´ë”</div>
        <div class="muted">í´ë”: ë“œë¡  / ë¶€ë™ì‚° / PET / í•´ì™¸ / ê¸°íƒ€</div>

        <div class="row" style="margin-top:8px;">
          <select id="fav_folder">
            <option value="ALL">ì „ì²´</option>
            <option value="DRONE">ë“œë¡ </option>
            <option value="REALESTATE">ë¶€ë™ì‚°</option>
            <option value="PET">PET</option>
            <option value="GLOBAL">í•´ì™¸</option>
            <option value="ETC">ê¸°íƒ€</option>
          </select>

          <input id="fav_search" placeholder="ì¦ê²¨ì°¾ê¸° ê²€ìƒ‰(ì œëª©/ì±„ë„ëª…)" size="18" />
          <select id="fav_sort">
            <option value="recent_desc">ìµœê·¼ ì €ì¥ â†“</option>
            <option value="latest_desc">ìµœê·¼ ì—…ë¡œë“œ â†“(ì±„ë„)</option>
            <option value="eff_desc">íš¨ìœ¨ â†“</option>
            <option value="views_desc">ì¡°íšŒìˆ˜ â†“(ì˜ìƒ)</option>
            <option value="subs_desc">êµ¬ë…ì â†“(ì±„ë„)</option>
            <option value="title_asc">ì´ë¦„ Aâ†’Z</option>
          </select>

          <span class="right"></span>
          <button id="fav_refresh" class="miniBtn primary">ìµœê·¼ì—…ë¡œë“œ ê°±ì‹ </button>
          <button id="fav_csv" class="miniBtn primary">CSV(ì—‘ì…€)</button>
          <button id="fav_export" class="miniBtn">JSON</button>
          <button id="fav_clear" class="miniBtn">ì „ì²´ì‚­ì œ</button>
        </div>

        <div class="muted" id="fav_count" style="margin-top:6px;">(0)</div>

        <div class="favBox">
          <div class="favBody" id="fav_list"></div>
        </div>

        <div class="hint">
          âœ… â€œìµœê·¼ì—…ë¡œë“œ ê°±ì‹ â€ì€ ì¦ê²¨ì°¾ê¸° ì±„ë„ì„ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.<br/>
          âœ… íš¨ìœ¨ = (ìµœê·¼ 10ê°œ í‰ê· ì¡°íšŒìˆ˜) Ã· (êµ¬ë…ììˆ˜) Ã— 100
        </div>
      </div>
    </div>
  </aside>

<script>
/** =========================================================
 *  âœ… íˆ¬ë¹„9 API KEY
 *  ========================================================= */
const API_KEY = "AIzaSyC_zX8fpFowj_yG_7CVD5HiNUSxdcWVNhw";
/** ========================================================= */

const PRESETS = {
  drone: {
    video:   { q: "ë“œë¡ ",  or: "", ex: "", region: "KR", order: "viewCount" },
    channel: { q: "ë“œë¡ ",  or: "", ex: "", region: "KR", order: "relevance" }
  },
  realestate: {
    video:   { q: "ë¶€ë™ì‚°", or: "", ex: "", region: "KR", order: "viewCount" },
    channel: { q: "ë¶€ë™ì‚°", or: "", ex: "", region: "KR", order: "relevance" }
  },
  pet: {
    video:   { q: "PET",  or: "", ex: "", region: "KR", order: "viewCount" },
    channel: { q: "PET",  or: "", ex: "", region: "KR", order: "relevance" }
  },
  global: {
    video:   { q: "trending", or: "", ex: "", region: "US", order: "viewCount" },
    channel: { q: "trending", or: "", ex: "", region: "US", order: "relevance" }
  }
};


const REGION_CODES = [
  ["", "ì „ì²´(ë¯¸ì§€ì •)"],
  ["KR", "ëŒ€í•œë¯¼êµ­(KR)"],["US", "ë¯¸êµ­(US)"],["JP", "ì¼ë³¸(JP)"],["CN", "ì¤‘êµ­(CN)"],["TW", "ëŒ€ë§Œ(TW)"],["HK", "í™ì½©(HK)"],
  ["SG", "ì‹±ê°€í¬ë¥´(SG)"],["TH", "íƒœêµ­(TH)"],["VN", "ë² íŠ¸ë‚¨(VN)"],["PH", "í•„ë¦¬í•€(PH)"],["ID", "ì¸ë„ë„¤ì‹œì•„(ID)"],["MY","ë§ë ˆì´ì‹œì•„(MY)"],
  ["IN","ì¸ë„(IN)"],["AU","í˜¸ì£¼(AU)"],["NZ","ë‰´ì§ˆëœë“œ(NZ)"],["GB","ì˜êµ­(GB)"],["FR","í”„ë‘ìŠ¤(FR)"],["DE","ë…ì¼(DE)"],["ES","ìŠ¤í˜ì¸(ES)"],
  ["IT","ì´íƒˆë¦¬ì•„(IT)"],["BR","ë¸Œë¼ì§ˆ(BR)"],["MX","ë©•ì‹œì½”(MX)"],["CA","ìºë‚˜ë‹¤(CA)"],["TR","íŠ€ë¥´í‚¤ì˜ˆ(TR)"],["RU","ëŸ¬ì‹œì•„(RU)"],["ZA","ë‚¨ì•„ê³µ(ZA)"]
];

const $ = (id) => document.getElementById(id);

function setStatus(el, msg) { if(el) el.textContent = msg; }
function fmtNum(n) { const x = Number(n ?? 0); return Number.isFinite(x) ? x.toLocaleString() : ""; }
function toDate(iso) { return iso ? iso.slice(0,10) : ""; }
function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function csvEscape(v) {
  const s = String(v ?? "");
  if (/[,"\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}
// âœ… ì¿¼í„°/ê³¼í˜¸ì¶œ ë°©ì§€ìš© ì „ì—­ ìƒíƒœ
let autoTimer = null;      // ìë™ê°±ì‹  íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì €ì¥
let _inFlight = 0;         // ë™ì‹œì— ë‚˜ê°€ëŠ” í˜¸ì¶œ ê°œìˆ˜
const MAX_INFLIGHT = 3;    // ë™ì‹œ í˜¸ì¶œ ì œí•œ(2~4 ì¶”ì²œ)

function stopAutoRefresh(){
  if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
}

// âœ… Errorê°€ quotaì¸ì§€ íŒë³„
function isQuotaError(data, res){
  const reason = data?.error?.errors?.[0]?.reason || "";
  const msg = data?.error?.message || "";
  const code = data?.error?.code || res?.status || 0;

  return (
    code === 403 && (reason.includes("quota") || msg.toLowerCase().includes("quota")) ||
    code === 429 ||
    reason === "quotaExceeded" ||
    reason === "dailyLimitExceeded" ||
    reason === "userRateLimitExceeded"
  );
}

// âœ… ê°„ë‹¨ ëŒ€ê¸°
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function ytFetch(url) {
  // âœ… ë™ì‹œ í˜¸ì¶œ ì œí•œ(ë„ˆë¬´ ë§ì´ ë™ì‹œì— ë‚˜ê°€ë©´ quota/limit ë” ë¹¨ë¦¬ í„°ì§)
  while (_inFlight >= MAX_INFLIGHT) {
    await sleep(80);
  }
  _inFlight++;

  try{
    const res = await fetch(url);
    const data = await res.json().catch(()=> ({}));

    // âœ… ì¿¼í„°/ë ˆì´íŠ¸ë¦¬ë°‹ì´ë©´: ìë™ê°±ì‹  ì¤‘ë‹¨ + ì¹œì ˆ ì•ˆë‚´
    if (isQuotaError(data, res)) {
      stopAutoRefresh();
      throw new Error("YouTube API í• ë‹¹ëŸ‰(Quota) ë˜ëŠ” í˜¸ì¶œ ì œí•œì— ê±¸ë ¸ìŠµë‹ˆë‹¤. ìë™ê°±ì‹ ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„(ë˜ëŠ” ë‹¤ìŒë‚ ) ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }

    if (!res.ok || data.error) {
      throw new Error(data?.error?.message || `API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ${res.status})`);
    }
    return data;
  } finally {
    _inFlight--;
  }
}
function ensureKey() {
  if (!API_KEY || API_KEY.includes("YOUR_API_KEY")) {
    alert("API_KEYë¥¼ ë¨¼ì € ë³¸ì¸ ê²ƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”!");
    return false;
  }
  return true;
}
function fillRegionSelect(selectEl) {
  if(!selectEl) return;
  selectEl.innerHTML = "";
  for (const [code, label] of REGION_CODES) {
    const opt = document.createElement("option");
    opt.value = code;
    opt.textContent = label;
    selectEl.appendChild(opt);
  }
  selectEl.value = "KR";
}
function buildDateRFC3339(dateStr, endOfDay=false) {
  if (!dateStr) return "";
  return endOfDay ? `${dateStr}T23:59:59Z` : `${dateStr}T00:00:00Z`;
}
function buildQuery(base, orCsv, exCsv) {
  const parts = [];
  if (base?.trim()) parts.push(base.trim());
  const orList = (orCsv || "").split(",").map(s => s.trim()).filter(Boolean);
  if (orList.length) parts.push(orList.join(" OR "));
  const exList = (exCsv || "").split(",").map(s => s.trim()).filter(Boolean)
    .map(s => s.startsWith("-") ? s : `-${s}`);
  parts.push(...exList);
  return parts.join(" ").replace(/\s+/g, " ").trim();
}
function daysAgo(iso) {
  if (!iso) return 9999;
  const d = new Date(iso);
  const now = new Date();
  return Math.max(0, Math.floor((now - d) / (1000*60*60*24)));
}
function scoreVideo(viewCount, subs, publishedAt) {
  const v = Math.log10((Number(viewCount)||0) + 1);
  const s = Math.log10((Number(subs)||0) + 1);
  const age = daysAgo(publishedAt);
  const recency = Math.max(0, 30 - age) / 30;
  return Math.round((v*60) + (s*35) + (recency*20));
}
function calcEfficiency(avgViews10, subs) {
  const s = Number(subs || 0);
  if (s <= 0) return 0;
  return Math.round((Number(avgViews10 || 0) / s) * 10000) / 100; // ì†Œìˆ˜ 2ìë¦¬
}
function autoFolderByText(text) {
  const t = (text || "").toLowerCase();
  if (/(drone|ë“œë¡ |ìê²©ì¦|ì§€ë„ì¡°ì¢…ì|ë¹„í–‰|êµìœ¡ì›)/.test(t)) return "DRONE";
  if (/(ë¶€ë™ì‚°|ê³µì¸ì¤‘ê°œ|ì „ì›ì£¼íƒ|í† ì§€|ë¶„ì–‘|ê°œë°œ|ì•„íŒŒíŠ¸)/.test(t)) return "REALESTATE";
  if (/(pet|ê°•ì•„ì§€|ë°˜ë ¤|ë©ë©|ê³ ì–‘ì´|cat|dog|puppy)/.test(t)) return "PET";
  if (/(global|english|usa|america|world|í•´ì™¸|ì™¸êµ­|shorts)/.test(t)) return "GLOBAL";
  return "ETC";
}

/** ========== ë“œë¡œì–´ ì—´ê³  ë‹«ê¸° ========== */
function openAnalyzerDrawer(){
  $("anDrawer")?.classList.add("open");
  $("anDrawer")?.setAttribute("aria-hidden","false");
  $("anBackdrop")?.classList.add("show");
}
function closeAnalyzerDrawer(){
  $("anDrawer")?.classList.remove("open");
  $("anDrawer")?.setAttribute("aria-hidden","true");
  $("anBackdrop")?.classList.remove("show");
}
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAnalyzerDrawer(); });

/** ========== ì¦ê²¨ì°¾ê¸° ========== */
const FAV_KEY = "YT_PRO_PP_V4_FAVORITES";
let favorites = { videos:{}, channels:{} };

function loadFav() {
  try {
    const raw = localStorage.getItem(FAV_KEY);
    if (raw) favorites = JSON.parse(raw);
  } catch(_) {}
  favorites.videos ||= {};
  favorites.channels ||= {};
  renderFav();
}
function saveFav() {
  localStorage.setItem(FAV_KEY, JSON.stringify(favorites));
  renderFav();
}
function favCount() {
  const v = Object.keys(favorites.videos).length;
  const c = Object.keys(favorites.channels).length;
  return { v, c, total: v+c };
}
function nowISO() { return new Date().toISOString(); }

function addFavVideo(r) {
  const folder = autoFolderByText(`${r.title} ${r.channelTitle}`);
  favorites.videos[r.videoId] = {
    type: "video", folder, savedAt: nowISO(),
    videoId: r.videoId, title: r.title, viewCount: r.viewCount, publishedAt: r.publishedAt,
    channelId: r.channelId, channelTitle: r.channelTitle, subscribers: r.subscribers
  };
  if (r.channelId && !favorites.channels[r.channelId]) {
    favorites.channels[r.channelId] = {
      type: "channel", folder, savedAt: nowISO(),
      channelId: r.channelId, channelTitle: r.channelTitle,
      subscribers: r.subscribers || 0, totalViews: 0, latestUploadDate: "", avgViews10: 0, efficiency: 0
    };
  }
  saveFav();
}
function addFavChannel(r) {
  const folder = autoFolderByText(`${r.channelTitle} ${r.description || ""}`);
  favorites.channels[r.channelId] = {
    ...(favorites.channels[r.channelId] || {}),
    type:"channel", folder,
    savedAt: favorites.channels[r.channelId]?.savedAt || nowISO(),
    channelId: r.channelId,
    channelTitle: r.channelTitle,
    subscribers: r.subscribers || 0,
    totalViews: r.totalViews ?? 0,
    latestUploadDate: favorites.channels[r.channelId]?.latestUploadDate || "",
    avgViews10: favorites.channels[r.channelId]?.avgViews10 || 0,
    efficiency: favorites.channels[r.channelId]?.efficiency || 0,
    description: r.description || ""
  };
  saveFav();
}

async function refreshChannelLatest(channelId) {
  const sUrl = new URL("https://www.googleapis.com/youtube/v3/search");
  sUrl.searchParams.set("part","snippet");
  sUrl.searchParams.set("channelId", channelId);
  sUrl.searchParams.set("type","video");
  sUrl.searchParams.set("order","date");
  sUrl.searchParams.set("maxResults","10");
  sUrl.searchParams.set("key", API_KEY);

  const sData = await ytFetch(sUrl.toString());
  const ids = (sData.items || []).map(x => x?.id?.videoId).filter(Boolean);
  if (!ids.length) return { latest:"", avg10:0 };

  const latestISO = sData.items?.[0]?.snippet?.publishedAt || "";

  const vUrl = new URL("https://www.googleapis.com/youtube/v3/videos");
  vUrl.searchParams.set("part","statistics");
  vUrl.searchParams.set("id", ids.join(","));
  vUrl.searchParams.set("key", API_KEY);

  const vData = await ytFetch(vUrl.toString());
  const views = (vData.items || []).map(v => Number(v.statistics?.viewCount || 0));
  const avg10 = views.length ? Math.round(views.reduce((a,b)=>a+b,0)/views.length) : 0;

  return { latest: latestISO, avg10 };
}

async function refreshAllFavChannels0() {
  if (!ensureKey()) return;

  const ids = Object.keys(favorites.channels || {});
  if (!ids.length) return alert("ì¦ê²¨ì°¾ê¸° ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤!");

  const btn = $("fav_refresh");
  btn.disabled = true;
  btn.textContent = "ê°±ì‹  ì¤‘... (0/" + ids.length + ")";

  let ok = 0, fail = 0;

  for (let i = 0; i < ids.length; i++) {
    const id = ids[i];

    try {
      const r = await refreshChannelLatest(id);

      const ch = favorites.channels[id];
      if (!ch) continue;

      ch.latestUploadDate = r.latest;
      ch.avgViews10 = r.avg10;
      ch.efficiency = calcEfficiency(r.avg10, ch.subscribers);
      ok++;

    } catch (e) {
      fail++;
      const msg = (e && e.message) ? e.message : String(e || "");

      // âœ… quota/limit ê±¸ë¦¬ë©´ ì¦‰ì‹œ ì¤‘ë‹¨
      if (/quota|limit|rate/i.test(msg)) {
        alert("YouTube API í• ë‹¹ëŸ‰(Quota) ë˜ëŠ” í˜¸ì¶œ ì œí•œì— ê±¸ë ¸ìŠµë‹ˆë‹¤.\nì§€ê¸ˆì€ ì—¬ê¸°ì„œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.\nì ì‹œ í›„(ë˜ëŠ” ë‚´ì¼) ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        break;
      }
    }

    // âœ… ë„ˆë¬´ ë¹ ë¥´ê²Œ ëª°ì•„ì¹˜ì§€ ì•Šê²Œ ì•½ê°„ ì‰¬ê¸°
    await sleep(250);

    btn.textContent = `ê°±ì‹  ì¤‘... (${Math.min(i + 1, ids.length)}/${ids.length})`;
  }

  // âœ… ì €ì¥ì€ ë§ˆì§€ë§‰ì— 1ë²ˆë§Œ
  saveFav();

  btn.disabled = false;
  btn.textContent = "ìµœê·¼ì—…ë¡œë“œ ê°±ì‹ ";

  alert(`ê°±ì‹  ì™„ë£Œ! (${ok}/${ids.length})` + (fail ? `\nì‹¤íŒ¨: ${fail}` : ""));
}

function renderFav() {
  const { total } = favCount();
  $("fav_count").textContent = `ì¦ê²¨ì°¾ê¸° ì´ ${total}ê°œ`;

  const list = $("fav_list");
  list.innerHTML = "";

  const folderFilter = $("fav_folder")?.value || "ALL";
  const q = ($("fav_search")?.value || "").trim().toLowerCase();
  const sortMode = $("fav_sort")?.value || "recent_desc";

  const items = [];
  for (const id of Object.keys(favorites.channels)) items.push({ ...favorites.channels[id] });
  for (const id of Object.keys(favorites.videos)) items.push({ ...favorites.videos[id] });

  let filtered = items;
  if (folderFilter !== "ALL") filtered = filtered.filter(it => it.folder === folderFilter);
  if (q) filtered = filtered.filter(it => ((it.channelTitle || it.title || "").toLowerCase()).includes(q));

  filtered.sort((a,b) => {
    if (sortMode === "recent_desc") return (b.savedAt||"").localeCompare(a.savedAt||"");
    if (sortMode === "latest_desc") return (b.latestUploadDate||"").localeCompare(a.latestUploadDate||"");
    if (sortMode === "eff_desc") return Number(b.efficiency||0) - Number(a.efficiency||0);
    if (sortMode === "views_desc") return (Number(b.viewCount||0) - Number(a.viewCount||0));
    if (sortMode === "subs_desc") return (Number(b.subscribers||0) - Number(a.subscribers||0));
    if (sortMode === "title_asc") return ((a.channelTitle||a.title||"").localeCompare((b.channelTitle||b.title||""), "ko"));
    return 0;
  });

  if (!filtered.length) {
    const empty = document.createElement("div");
    empty.className = "favItem";
    empty.innerHTML = `<div class="m">ì¦ê²¨ì°¾ê¸°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. â˜… ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•´ë³´ì„¸ìš”.</div>`;
    list.appendChild(empty);
    return;
  }

  for (const it of filtered) {
    const div = document.createElement("div");
    div.className = "favItem";

    const url = it.type === "channel"
      ? `https://www.youtube.com/channel/${it.channelId}`
      : `https://www.youtube.com/watch?v=${it.videoId}`;

    const title = it.type === "channel" ? it.channelTitle : it.title;

    const folderName = ({
      DRONE:"ğŸš ë“œë¡ ", REALESTATE:"ğŸ  ë¶€ë™ì‚°", PET:"ğŸ¶ PET", GLOBAL:"ğŸŒ í•´ì™¸", ETC:"ğŸ“¦ ê¸°íƒ€"
    })[it.folder] || "ğŸ“¦ ê¸°íƒ€";

    const sub = it.type === "channel"
      ? `êµ¬ë…ì ${fmtNum(it.subscribers)} Â· ì´ì¡°íšŒìˆ˜ ${fmtNum(it.totalViews || 0)} Â· ìµœê·¼ì—…ë¡œë“œ ${toDate(it.latestUploadDate) || "-"}`
      : `ì¡°íšŒìˆ˜ ${fmtNum(it.viewCount)} Â· ${toDate(it.publishedAt)}`;

    const effText = it.type === "channel"
      ? `íš¨ìœ¨ ${fmtNum(it.efficiency)} (ìµœê·¼10í‰ê·  ${fmtNum(it.avgViews10)} / êµ¬ë…ì ${fmtNum(it.subscribers)})`
      : "";

    div.innerHTML = `
      <div style="min-width:0;">
        <div class="t">${folderName} Â· ${it.type === "channel" ? "ğŸ“º " : "ğŸ¬ "}${escapeHtml(title || "")}</div>
        <div class="m">${escapeHtml(sub)}</div>
        ${effText ? `<div class="m">${escapeHtml(effText)}</div>` : ``}
        <div class="m">ì €ì¥ì¼: ${toDate(it.savedAt)}</div>
        <div class="m link"><a href="${url}" target="_blank" rel="noopener">${url}</a></div>
      </div>
      <div class="actions">
        <button class="miniBtn" data-open="1">ì—´ê¸°</button>
        ${it.type==="channel" ? `<button class="miniBtn primary" data-an="1">ë¶„ì„</button>` : ""}
        <button class="miniBtn" data-del="1">ì‚­ì œ</button>
      </div>
    `;

    div.querySelector('[data-open="1"]').onclick = () => window.open(url, "_blank", "noopener");
    const anBtn = div.querySelector('[data-an="1"]');
    if (anBtn) anBtn.onclick = () => loadChannelDetails(it.channelId).catch(err=>alert(err.message));
    div.querySelector('[data-del="1"]').onclick = () => {
      if (it.type==="channel") delete favorites.channels[it.channelId];
      else delete favorites.videos[it.videoId];
      saveFav();
    };

    list.appendChild(div);
  }
}

/** ========== ë¶„ì„ íŒ¨ë„ ë¡œì§ ========== */
const analyzer = {
  channelId: null,
  channelUrl: null,
  setLoading(msg="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...") {
    openAnalyzerDrawer();
    $("an_title").textContent = "ì±„ë„ ë¶„ì„";
    $("an_sub").textContent = msg;
    $("an_subs").textContent = "-";
    $("an_views").textContent = "-";
    $("an_videos").textContent = "-";
    $("an_created").textContent = "-";
    $("an_latest_date").textContent = "-";
    $("an_eff").textContent = "-";
    $("an_eff_sub").textContent = "";
    $("an_desc").textContent = "";
    $("an_avatar").src = "";
    $("an_list").innerHTML = "";
    $("an_list_status").textContent = "";
    $("an_open").disabled = true;
    $("an_latest").disabled = true;
    $("an_fav").disabled = true;
  },
  setChannel(ch) {
    openAnalyzerDrawer();
    this.channelId = ch.channelId;
    this.channelUrl = `https://www.youtube.com/channel/${ch.channelId}`;

    $("an_title").textContent = ch.title || "ì±„ë„";
   $("an_sub").innerHTML =
  `${ch.country ? "êµ­ê°€: "+escapeHtml(ch.country)+" Â· " : ""}` +
  `<a href="${this.channelUrl}" target="_blank" rel="noopener" class="anLink">${this.channelUrl}</a>`;
    $("an_subs").textContent = fmtNum(ch.subs);
    $("an_views").textContent = fmtNum(ch.views);
    $("an_videos").textContent = fmtNum(ch.videos);
    $("an_created").textContent = toDate(ch.createdAt);
    $("an_desc").textContent = (ch.desc || "").slice(0, 220);
    $("an_avatar").src = ch.avatarUrl || "";

    $("an_open").disabled = false;
    $("an_latest").disabled = false;
    $("an_fav").disabled = false;

    $("an_open").onclick = () => window.open(this.channelUrl, "_blank", "noopener");
    $("an_latest").onclick = () => loadLatestVideosForChannel(this.channelId);
    $("an_fav").onclick = () => {
      addFavChannel({
        channelId: ch.channelId,
        channelTitle: ch.title,
        subscribers: ch.subs,
        totalViews: ch.views,
        description: ch.desc
      });
      alert("â˜… ì¦ê²¨ì°¾ê¸°ì— ì±„ë„ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤!");
    };
  }
};

async function loadChannelDetails(channelId) {
  analyzer.setLoading("ì±„ë„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

  const url = new URL("https://www.googleapis.com/youtube/v3/channels");
  url.searchParams.set("part","snippet,statistics");
  url.searchParams.set("id", channelId);
  url.searchParams.set("key", API_KEY);

  const data = await ytFetch(url.toString());
  const ch = data.items?.[0];
  if (!ch) throw new Error("ì±„ë„ ìƒì„¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

  const sn = ch.snippet || {};
  const st = ch.statistics || {};
  const avatarUrl = sn.thumbnails?.default?.url || sn.thumbnails?.medium?.url || "";

  analyzer.setChannel({
    channelId,
    title: sn.title || "",
    desc: sn.description || "",
    avatarUrl,
    country: sn.country || "",
    createdAt: sn.publishedAt || "",
    subs: Number(st.subscriberCount || 0),
    views: Number(st.viewCount || 0),
    videos: Number(st.videoCount || 0)
  });

  await loadLatestVideosForChannel(channelId);

  try {
    const r = await refreshChannelLatest(channelId);
    $("an_latest_date").textContent = toDate(r.latest) || "-";
    const eff = calcEfficiency(r.avg10, Number(st.subscriberCount || 0));
    $("an_eff").textContent = fmtNum(eff);
    $("an_eff_sub").textContent = `ìµœê·¼10í‰ê·  ${fmtNum(r.avg10)} / êµ¬ë…ì ${fmtNum(Number(st.subscriberCount||0))}`;
  } catch(_) {}
}

async function loadLatestVideosForChannel(channelId) {
  if (!ensureKey()) return;
  $("an_list_status").textContent = " (ê°€ì ¸ì˜¤ëŠ” ì¤‘...)";
  $("an_list").innerHTML = "";

  const sUrl = new URL("https://www.googleapis.com/youtube/v3/search");
  sUrl.searchParams.set("part", "snippet");
  sUrl.searchParams.set("channelId", channelId);
  sUrl.searchParams.set("type", "video");
  sUrl.searchParams.set("order", "date");
  sUrl.searchParams.set("maxResults", "10");
  sUrl.searchParams.set("key", API_KEY);

  const sData = await ytFetch(sUrl.toString());
  const ids = (sData.items || []).map(x => x?.id?.videoId).filter(Boolean);

  if (!ids.length) {
    $("an_list_status").textContent = " (ì˜ìƒ ì—†ìŒ)";
    return;
  }

  const vUrl = new URL("https://www.googleapis.com/youtube/v3/videos");
  vUrl.searchParams.set("part", "snippet,statistics");
  vUrl.searchParams.set("id", ids.join(","));
  vUrl.searchParams.set("key", API_KEY);

  const vData = await ytFetch(vUrl.toString());
  const items = (vData.items || []).map(v => {
    const sn = v.snippet || {};
    const st = v.statistics || {};
    const thumb = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || "";
    return { id: v.id, title: sn.title || "", publishedAt: sn.publishedAt || "", viewCount: Number(st.viewCount || 0), thumb };
  }).sort((a,b) => (b.publishedAt||"").localeCompare(a.publishedAt||""));

  $("an_list_status").textContent = ` (ì´ ${items.length}ê°œ í‘œì‹œ)`;

  const list = $("an_list");
  for (const it of items) {
    const url = `https://www.youtube.com/watch?v=${it.id}`;
    const div = document.createElement("div");
    div.className = "anItem";
    div.innerHTML = `
      <img src="${it.thumb}" alt="">
      <div style="min-width:0;">
        <div class="t">${escapeHtml(it.title)}</div>
        <div class="m">${toDate(it.publishedAt)} Â· ì¡°íšŒìˆ˜ ${fmtNum(it.viewCount)}</div>
        <div class="m link"><a href="${url}" target="_blank" rel="noopener">${url}</a></div>
      </div>
    `;
    list.appendChild(div);
  }
}

/** ========== ê²€ìƒ‰ í…Œì´ë¸”(ì˜ìƒ/ì±„ë„) ========== */
const v = { tbody:null, status:null, btnPrev:null, btnNext:null, btnCsv:null, sortLocal:null, history:[], pageToken:"", nextToken:null, rows:[], rendered:[] };
const c = { tbody:null, status:null, btnPrev:null, btnNext:null, btnCsv:null, sortLocal:null, history:[], pageToken:"", nextToken:null, rows:[] };

function wireTables() {
  v.tbody = $("v_tbl").querySelector("tbody");
  v.status = $("v_status");
  v.btnPrev = $("v_btnPrev");
  v.btnNext = $("v_btnNext");
  v.btnCsv = $("v_btnCsv");
  v.sortLocal = $("v_sortLocal");

  c.tbody = $("c_tbl").querySelector("tbody");
  c.status = $("c_status");
  c.btnPrev = $("c_btnPrev");
  c.btnNext = $("c_btnNext");
  c.btnCsv = $("c_btnCsv");
  c.sortLocal = $("c_sortLocal");
}

async function videoSearch({ pageToken="" } = {}) {
  if (!ensureKey()) return;
  const base = $("v_q").value.trim();
  if (!base) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
// âœ… ì›í´ë¦­ ê²€ìƒ‰(ëŒ€ë¶„ë¥˜ ë²„íŠ¼ìš©)
async function quickSearch(keyword) {
  if (!ensureKey()) return;

  // 1) ì˜ìƒ íƒ­ìœ¼ë¡œ ê°•ì œ ì´ë™
  setActiveTab("video");

  // 2) ê²€ìƒ‰ì–´ ì…ë ¥ì¹¸ì— í‚¤ì›Œë“œ ì£¼ì…
  const qEl = $("v_q");
if (qEl) {
  const cur = (qEl.value || "").trim();
  // ê¸°ì¡´ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´: (ê¸°ì¡´) AND (ë²„íŠ¼í‚¤ì›Œë“œ)
  qEl.value = cur ? `(${cur}) AND (${keyword})` : keyword;
}

  // (ì›í•˜ë©´) ì œì™¸í‚¤ì›Œë“œ ë¹„ìš°ê¸°
  // const exEl = $("v_ex"); if (exEl) exEl.value = "";

  // 3) í˜ì´ì§•/íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” í›„ ê²€ìƒ‰
  v.history = [];
  v.pageToken = "";
  try {
    await videoSearch({ pageToken: "" });
  } catch (e) {
    alert(e.message);
  }
}

  setStatus(v.status, "ê²€ìƒ‰ ì¤‘...");
  v.btnCsv.disabled = true;
  v.tbody.innerHTML = "";
  v.rows = [];
  v.rendered = [];

  const q = buildQuery(base, $("v_or").value, $("v_ex").value);
  const order = $("v_order").value;
  const region = $("v_region").value;
  const maxResults = $("v_maxResults").value;

  const after = buildDateRFC3339($("v_after").value, false);
  const before = buildDateRFC3339($("v_before").value, true);

  const searchUrl = new URL("https://www.googleapis.com/youtube/v3/search");
  searchUrl.searchParams.set("part", "snippet");
  searchUrl.searchParams.set("type", "video");
  searchUrl.searchParams.set("q", q);
  searchUrl.searchParams.set("order", order);
  searchUrl.searchParams.set("maxResults", maxResults);
  searchUrl.searchParams.set("key", API_KEY);
  if (region) searchUrl.searchParams.set("regionCode", region);
  if (after) searchUrl.searchParams.set("publishedAfter", after);
  if (before) searchUrl.searchParams.set("publishedBefore", before);
  if (pageToken) searchUrl.searchParams.set("pageToken", pageToken);

  const searchData = await ytFetch(searchUrl.toString());
  v.nextToken = searchData.nextPageToken || null;

  const videoIds = [];
  const channelIds = new Set();
  const thumbMapFromSearch = new Map();
  for (const item of (searchData.items || [])) {
    const vid = item?.id?.videoId;
    if (vid) videoIds.push(vid);
    const chId = item?.snippet?.channelId;
    if (chId) channelIds.add(chId);
    const th = item?.snippet?.thumbnails?.medium?.url || item?.snippet?.thumbnails?.default?.url || "";
    if (vid && th) thumbMapFromSearch.set(vid, th);
  }

  if (!videoIds.length) {
    setStatus(v.status, "ê²°ê³¼ ì—†ìŒ");
    v.btnNext.disabled = true;
    v.btnPrev.disabled = v.history.length === 0;
    return;
  }

  const videosUrl = new URL("https://www.googleapis.com/youtube/v3/videos");
  videosUrl.searchParams.set("part", "snippet,statistics");
  videosUrl.searchParams.set("id", videoIds.join(","));
  videosUrl.searchParams.set("key", API_KEY);
  const videosData = await ytFetch(videosUrl.toString());
  const videoMap = new Map();
  for (const item of (videosData.items || [])) videoMap.set(item.id, item);

  const channelsUrl = new URL("https://www.googleapis.com/youtube/v3/channels");
  channelsUrl.searchParams.set("part", "snippet,statistics");
  channelsUrl.searchParams.set("id", Array.from(channelIds).join(","));
  channelsUrl.searchParams.set("key", API_KEY);
  const channelsData = await ytFetch(channelsUrl.toString());
  const channelMap = new Map();
  for (const cItem of (channelsData.items || [])) channelMap.set(cItem.id, cItem);

  const rows = [];
  for (const vid of videoIds) {
    const vItem = videoMap.get(vid);
    if (!vItem) continue;

    const sn = vItem.snippet || {};
    const st = vItem.statistics || {};
    const ch = channelMap.get(sn.channelId) || {};
    const chSn = ch.snippet || {};
    const chSt = ch.statistics || {};

    const thumb = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || thumbMapFromSearch.get(vid) || "";
    const viewCount = Number(st.viewCount || 0);
    const subs = Number(chSt.subscriberCount || 0);
    const publishedAt = sn.publishedAt || "";
    const score = scoreVideo(viewCount, subs, publishedAt);

    rows.push({
      thumb,
      videoId: vid,
      title: sn.title || "",
      description: sn.description || "",
      tags: (sn.tags || []).slice(0, 30),
      publishedAt,
      channelId: sn.channelId || "",
      channelTitle: sn.channelTitle || "",
      viewCount,
      subscribers: subs,
      country: chSn.country || "",
      score
    });
  }

  v.rows = rows;
  applyVideoLocalSort();

  setStatus(v.status, `ì™„ë£Œ: ${rows.length}ê°œ Â· ë‹¤ìŒí˜ì´ì§€: ${v.nextToken ? "ìˆìŒ" : "ì—†ìŒ"}`);
  v.btnCsv.disabled = rows.length === 0;
  v.btnNext.disabled = !v.nextToken;
  v.btnPrev.disabled = v.history.length === 0;
}

function applyVideoLocalSort() {
  const data = [...v.rows].sort((a,b) => b.score - a.score);
  const minViews = Number($("v_minViews").value || 0);
  const minSubs = Number($("v_minSubs").value || 0);
  const dedupe = $("v_dedupeChannel").checked;

  let filtered = data.filter(x => x.viewCount >= minViews && x.subscribers >= minSubs);

  if (dedupe) {
    const bestByChannel = new Map();
    for (const r of filtered) {
      const prev = bestByChannel.get(r.channelId);
      if (!prev || r.score > prev.score) bestByChannel.set(r.channelId, r);
    }
    filtered = Array.from(bestByChannel.values());
  }

  v.rendered = filtered;
  renderVideoTable(filtered);
}

function toggleFavoriteVideo(videoId) {
  if (favorites.videos[videoId]) {
    delete favorites.videos[videoId];
    saveFav();
    return;
  }
  const row = v.rows.find(x => x.videoId === videoId);
  if (row) addFavVideo(row);
  else alert("ì¦ê²¨ì°¾ê¸° ì €ì¥ ì‹¤íŒ¨: ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
}

function analyzeChannel(channelId) {
  loadChannelDetails(channelId).catch(err => alert(err.message));
}

function wireVideoTableEvents() {
  const tbody = document.querySelector("#v_tbl tbody");
  if (!tbody) return;

  tbody.onclick = (e) => {
    // 1) â˜… ì €ì¥ ë²„íŠ¼
    const favBtn = e.target.closest('button[data-fav="1"]');
    if (favBtn) {
      e.preventDefault();
      e.stopPropagation();
      const vid = favBtn.dataset.videoid;
      if (!vid) return;
      toggleFavoriteVideo(vid);
      renderVideoTable(v.rendered);
      return;
    }

    // 2) ì±„ë„ ë¶„ì„(ë‹ë³´ê¸°) ë²„íŠ¼
    const anBtn = e.target.closest('button[data-analyze="1"]');
    if (anBtn) {
      e.preventDefault();
      e.stopPropagation();
      const channelId = anBtn.dataset.channelid;
      if (!channelId) return;
      analyzeChannel(channelId);
      return;
    }

  };
}
function wireChannelTableEvents() {
  // 1) ì±„ë„ íƒ­ í…Œì´ë¸” tbody ì°¾ê¸° (ë‘˜ ì¤‘ í•˜ë‚˜ê°€ ë³´í†µì…ë‹ˆë‹¤)
  const tbody =
    document.querySelector("#c_tbl tbody") ||
    document.querySelector("#c_tbody");

  if (!tbody) return;

  // 2) ì´ë²¤íŠ¸ ìœ„ì„: tbody ì „ì²´ì—ì„œ ë²„íŠ¼ í´ë¦­ë§Œ ì¡ìŒ
  tbody.onclick = (e) => {
    // â˜… ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ (ê¸°ì¡´ëŒ€ë¡œ ì“°ê³  ìˆë‹¤ë©´ ìœ ì§€)
    const favBtn = e.target.closest('button[data-fav="1"]');
    if (favBtn) {
      e.preventDefault();
      e.stopPropagation();
      // ê¸°ì¡´ ì½”ë“œê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©í•˜ì„¸ìš” (ì˜ˆ: addFavChannel / toggleFavoriteChannel ë“±)
      return;
    }

    // âœ… ì±„ë„ ë¶„ì„ ë²„íŠ¼
    const anBtn = e.target.closest('button[data-c-analyze="1"]');
    if (anBtn) {
      e.preventDefault();
      e.stopPropagation();

      const channelId = anBtn.dataset.channelid;
      if (!channelId) return;

      // ê¸°ì¡´ì— ì±„ë„ ìƒì„¸ ì—¬ëŠ” í•¨ìˆ˜ëª…ì— ë§ì¶° í•˜ë‚˜ë§Œ ë‚¨ê¸°ì„¸ìš”.
      if (typeof loadChannelDetails === "function") {
        loadChannelDetails(channelId).catch(err => alert(err.message));
      } else if (typeof analyzeChannel === "function") {
        analyzeChannel(channelId);
      } else {
        alert("ì±„ë„ ìƒì„¸/ë¶„ì„ í•¨ìˆ˜(loadChannelDetails/analyzeChannel)ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
      return;
    }
  };
}

function renderVideoTable(data) {
  v.tbody.innerHTML = "";
  for (const r of data) {
    const videoUrl = `https://www.youtube.com/watch?v=${r.videoId}`;
    const chUrl = `https://www.youtube.com/channel/${r.channelId}`;
    const isFav = !!favorites.videos[r.videoId];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <button class="miniBtn ${isFav ? "primary":""}" data-fav="1" data-videoid="${r.videoId}">
          ${isFav ? "â˜… ì €ì¥ë¨" : "â˜† ì €ì¥"}
        </button>
      </td>
      <td><img class="thumb" src="${r.thumb}" alt=""></td>
      <td>
        <div><b>${escapeHtml(r.title)}</b></div>
        <div class="link small">
          <a href="${videoUrl}" target="_blank" rel="noopener">${videoUrl}</a>
        </div>
      </td>
      <td>${toDate(r.publishedAt)}</td>
      <td>${fmtNum(r.viewCount)}</td>
      <td>${fmtNum(r.subscribers)}</td>
      <td>${escapeHtml(r.country || "")}</td>
      <td><b>${fmtNum(r.score)}</b></td>
           <td>
  <div><b>${escapeHtml(r.channelTitle)}</b></div>
  <div class="muted small">ì›í•˜ëŠ” ë™ì‘ì„ ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰</div>

  <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
    <!-- ğŸ” ë¶„ì„ -->
    <button class="miniBtn primary"
            data-analyze="1"
            data-channelid="${r.channelId}"
            title="ì±„ë„ ë¶„ì„">ğŸ” ë¶„ì„</button>

     </div>
</td>


    `;
    v.tbody.appendChild(tr);
  }
}

function exportVideoCsv() {
  if (!v.rows.length) return alert("ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
  const header = ["score","title","videoUrl","channelTitle","channelUrl","publishedAt","viewCount","subscriberCount","country","tags","description"];
  const lines = [header.join(",")];
  for (const r of v.rows) {
    const row = [
      r.score, r.title,
      `https://www.youtube.com/watch?v=${r.videoId}`,
      r.channelTitle,
      `https://www.youtube.com/channel/${r.channelId}`,
      r.publishedAt,
      r.viewCount,
      r.subscribers,
      r.country,
      (r.tags || []).join(" "),
      r.description
    ].map(csvEscape).join(",");
    lines.push(row);
  }
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "youtube_video_results_pro_pp_v4.csv";
  a.click();
  URL.revokeObjectURL(url);
}

async function videoNext() {
  if (!v.nextToken) return;
  v.history.push(v.pageToken || "");
  v.pageToken = v.nextToken;
  await videoSearch({ pageToken: v.pageToken });
}
async function videoPrev() {
  if (!v.history.length) return;
  v.pageToken = v.history.pop();
  await videoSearch({ pageToken: v.pageToken });
}
// âœ… ì›í´ë¦­ ê²€ìƒ‰(ëŒ€ë¶„ë¥˜ ë²„íŠ¼ìš©)
async function quickSearch(keyword) {
  if (!ensureKey()) return;

  // 1) ì˜ìƒ íƒ­ìœ¼ë¡œ ê°•ì œ ì´ë™
  setActiveTab("video");

  // 2) ê²€ìƒ‰ì–´ ì…ë ¥ì¹¸ì— í‚¤ì›Œë“œ ì£¼ì…
  const qEl = $("v_q");
  if (qEl) qEl.value = keyword;

  // (ì›í•˜ë©´) ì œì™¸í‚¤ì›Œë“œ ë¹„ìš°ê¸°
  // const exEl = $("v_ex"); if (exEl) exEl.value = "";

  // 3) í˜ì´ì§•/íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” í›„ ê²€ìƒ‰
  v.history = [];
  v.pageToken = "";
  try {
    await videoSearch({ pageToken: "" });
  } catch (e) {
    alert(e.message);
  }
}

/** ì±„ë„ ê²€ìƒ‰(í•„ìš” ìµœì†Œ ìœ ì§€) */
async function channelSearch({ pageToken="" } = {}) {
  if (!ensureKey()) return;
  const base = $("c_q").value.trim();
  if (!base) return alert("ì±„ë„ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  setStatus(c.status, "ê²€ìƒ‰ ì¤‘...");
  c.btnCsv.disabled = true;
  c.tbody.innerHTML = "";
  c.rows = [];

  const q = buildQuery(base, $("c_or").value, $("c_ex").value);
  const order = $("c_order").value;
  const region = $("c_region").value;
  const maxResults = $("c_maxResults").value;

  const after = buildDateRFC3339($("c_after").value, false);
  const before = buildDateRFC3339($("c_before").value, true);

  const searchUrl = new URL("https://www.googleapis.com/youtube/v3/search");
  searchUrl.searchParams.set("part", "snippet");
  searchUrl.searchParams.set("type", "channel");
  searchUrl.searchParams.set("q", q);
  searchUrl.searchParams.set("order", order);
  searchUrl.searchParams.set("maxResults", maxResults);
  searchUrl.searchParams.set("key", API_KEY);
  if (region) searchUrl.searchParams.set("regionCode", region);
  if (after) searchUrl.searchParams.set("publishedAfter", after);
  if (before) searchUrl.searchParams.set("publishedBefore", before);
  if (pageToken) searchUrl.searchParams.set("pageToken", pageToken);

  const sData = await ytFetch(searchUrl.toString());
  c.nextToken = sData.nextPageToken || null;

  const channelIds = [];
  for (const item of (sData.items || [])) {
    const cid = item?.id?.channelId || item?.snippet?.channelId;
    if (cid) channelIds.push(cid);
  }

  if (!channelIds.length) {
    setStatus(c.status, "ê²°ê³¼ ì—†ìŒ");
    c.btnNext.disabled = true;
    c.btnPrev.disabled = c.history.length === 0;
    return;
  }

  const channelsUrl = new URL("https://www.googleapis.com/youtube/v3/channels");
  channelsUrl.searchParams.set("part", "snippet,statistics");
  channelsUrl.searchParams.set("id", channelIds.join(","));
  channelsUrl.searchParams.set("key", API_KEY);
  const chData = await ytFetch(channelsUrl.toString());

  const rows = [];
  for (const ch of (chData.items || [])) {
    const sn = ch.snippet || {};
    const st = ch.statistics || {};
    rows.push({
      channelId: ch.id,
      channelTitle: sn.title || "",
      description: sn.description || "",
      country: sn.country || "",
      createdAt: sn.publishedAt || "",
      subscribers: Number(st.subscriberCount || 0),
      totalViews: Number(st.viewCount || 0),
      videoCount: Number(st.videoCount || 0)
    });
  }
  c.rows = rows;
  renderChannelTable(rows);

  setStatus(c.status, `ì™„ë£Œ: ${rows.length}ê°œ`);
  c.btnCsv.disabled = rows.length === 0;
  c.btnNext.disabled = !c.nextToken;
  c.btnPrev.disabled = c.history.length === 0;
}

function renderChannelTable(data) {
  c.tbody.innerHTML = "";
  for (const r of data) {
    const chUrl = `https://www.youtube.com/channel/${r.channelId}`;
    const channelId = r.channelId;   // â† chUrl ë§Œë“¤ ë•Œ ì“°ëŠ” ê·¸ ê°’ê³¼ ë™ì¼í•´ì•¼ í•¨
    const isFav = !!favorites.channels[r.channelId];

    const tr = document.createElement("tr");
    tr.className = "clickable";
    tr.innerHTML = `
      <td><button class="miniBtn ${isFav ? "primary":""}" data-fav="1">${isFav ? "â˜… ì €ì¥ë¨" : "â˜† ì €ì¥"}</button></td>
      <td>${escapeHtml(r.channelTitle)}</td>
      <td>${fmtNum(r.subscribers)}</td>
      <td>${fmtNum(r.totalViews)}</td>
      <td>${fmtNum(r.videoCount)}</td>
      <td>${toDate(r.createdAt)}</td>
      <td>${escapeHtml(r.country || "")}</td>
      <td class="chanActions">
  <button class="miniBtn primary"
          data-c-analyze="1"
          data-channelid="${r.channelId}"
          title="ì±„ë„ ë¶„ì„">ğŸ” ë¶„ì„</button>
</td>
      <td class="wmax">${escapeHtml(r.description)}</td><td>
  
    `;

    tr.querySelector('[data-fav="1"]').onclick = (e) => {
      e.stopPropagation();
      addFavChannel(r);
      alert("â˜… ì¦ê²¨ì°¾ê¸°ì— ì±„ë„ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤! (í´ë” ìë™ë¶„ë¥˜)");
      renderChannelTable(data);
    };

     c.tbody.appendChild(tr);
  }
}

function exportChannelCsv() {
  if (!c.rows.length) return alert("ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
  const header = ["channelTitle","channelUrl","subscriberCount","totalViews","videoCount","createdAt","country","description"];
  const lines = [header.join(",")];
  for (const r of c.rows) {
    const row = [
      r.channelTitle,
      `https://www.youtube.com/channel/${r.channelId}`,
      r.subscribers,
      r.totalViews,
      r.videoCount,
      r.createdAt,
      r.country,
      r.description
    ].map(csvEscape).join(",");
    lines.push(row);
  }
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "youtube_channel_results_pro_pp_v4.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/** ========== ì„¤ì • JSON ========== */
const SETTINGS_KEY = "YT_SEARCH_PRO_PP_SETTINGS_V4";
function collectSettings() {
  return {
    video: {
      q: $("v_q").value, or: $("v_or").value, ex: $("v_ex").value,
      order: $("v_order").value, region: $("v_region").value, maxResults: $("v_maxResults").value,
      after: $("v_after").value, before: $("v_before").value,
      minViews: $("v_minViews").value, minSubs: $("v_minSubs").value,
      dedupeChannel: $("v_dedupeChannel").checked
    },
    channel: {
      q: $("c_q").value, or: $("c_or").value, ex: $("c_ex").value,
      order: $("c_order").value, region: $("c_region").value, maxResults: $("c_maxResults").value,
      after: $("c_after").value, before: $("c_before").value
    },
    favoritesFolder: $("fav_folder").value || "ALL"
  };
}
function applySettings(s) {
  if (!s) return;
  if (s.video) {
    $("v_q").value = s.video.q ?? "";
    $("v_or").value = s.video.or ?? "";
    $("v_ex").value = s.video.ex ?? "";
    $("v_order").value = s.video.order ?? "relevance";
    $("v_region").value = s.video.region ?? "KR";
    $("v_maxResults").value = s.video.maxResults ?? "20";
    $("v_after").value = s.video.after ?? "";
    $("v_before").value = s.video.before ?? "";
    $("v_minViews").value = s.video.minViews ?? "";
    $("v_minSubs").value = s.video.minSubs ?? "";
    $("v_dedupeChannel").checked = s.video.dedupeChannel ?? true;
  }
  if (s.channel) {
    $("c_q").value = s.channel.q ?? "";
    $("c_or").value = s.channel.or ?? "";
    $("c_ex").value = s.channel.ex ?? "";
    $("c_order").value = s.channel.order ?? "relevance";
    $("c_region").value = s.channel.region ?? "KR";
    $("c_maxResults").value = s.channel.maxResults ?? "20";
    $("c_after").value = s.channel.after ?? "";
    $("c_before").value = s.channel.before ?? "";
  }
  if (s.favoritesFolder && $("fav_folder")) $("fav_folder").value = s.favoritesFolder;
  renderFav();
}
function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(collectSettings()));
  alert("ì„¤ì • ì €ì¥ ì™„ë£Œ!");
}
function loadSettings() {
  const raw = localStorage.getItem(SETTINGS_KEY);
  if (!raw) return alert("ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
  applySettings(JSON.parse(raw));
  alert("ì„¤ì • ì—´ê¸° ì™„ë£Œ!");
}
function exportSettingsJSON() {
  const txt = JSON.stringify(collectSettings(), null, 2);
  const blob = new Blob([txt], { type:"application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "yt_search_pro_pp_v4_settings.json";
  a.click();
  URL.revokeObjectURL(url);
}
function openImportDialog() {
  $("importJson").value = "";
  $("dlgStatus").textContent = "";
  $("dlgImport").showModal();
}
function closeImportDialog() { $("dlgImport").close(); }
function applyImportJson() {
  try {
    const obj = JSON.parse($("importJson").value);
    applySettings(obj);
    $("dlgStatus").textContent = "ì ìš© ì™„ë£Œ!";
  } catch (e) {
    $("dlgStatus").textContent = "JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }


/** ========== íƒ­ ì „í™˜ ========== */
function setActiveTab(tabName) {
  const isVideo = tabName === "video";
  $("tabVideo").classList.toggle("active", isVideo);
  $("tabChannel").classList.toggle("active", !isVideo);
  $("panelVideo").classList.toggle("active", isVideo);
  $("panelChannel").classList.toggle("active", !isVideo);
}

/** ========== í”„ë¦¬ì…‹ ========== */
async function applyPreset(key){
  const p = PRESETS[key];
  if (!p) return;

  // âœ… ëŒ€ë¶„ë¥˜ë§Œ ì„¸íŒ…
  $("v_q").value = p.video.q;

  // âœ… OR/ì œì™¸í‚¤ì›Œë“œëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì“°ëŠ” ì˜ì—­ â†’ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
  // $("v_or").value = "";
  // $("v_ex").value = "";

  $("v_region").value = p.video.region || "KR";
  $("v_order").value  = p.video.order  || "relevance";

  // íƒ­ ì´ë™ + ë°”ë¡œ ê²€ìƒ‰
  setActiveTab("video");
  v.history = []; v.pageToken = "";
  try { await videoSearch({ pageToken: "" }); }
  catch(e){ alert(e.message); }
}

}

/** ========== ë‚´ë³´ë‚´ê¸°(ì¦ê²¨ì°¾ê¸°) ========== */
function exportFavJSON() {
  const txt = JSON.stringify(favorites, null, 2);
  const blob = new Blob([txt], { type:"application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "yt_favorites_pro_pp_v4.json";
  a.click();
  URL.revokeObjectURL(url);
}
function exportFavCSV() {
  const items = [];
  for (const id of Object.keys(favorites.channels)) items.push(favorites.channels[id]);
  for (const id of Object.keys(favorites.videos)) items.push(favorites.videos[id]);
  if (!items.length) return alert("ì¦ê²¨ì°¾ê¸°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

  const header = [
    "type","folder","savedAt","titleOrChannel","videoId","channelId","videoUrl","channelUrl",
    "viewCount","publishedAt","subscribers","totalViews","latestUploadDate","avgViews10","efficiency"
  ];
  const lines = [header.join(",")];

  for (const it of items) {
    const isChannel = it.type === "channel";
    const videoUrl = isChannel ? "" : `https://www.youtube.com/watch?v=${it.videoId}`;
    const channelUrl = `https://www.youtube.com/channel/${it.channelId}`;
    const row = [
      it.type, it.folder || "", it.savedAt || "",
      isChannel ? (it.channelTitle||"") : (it.title||""),
      it.videoId || "", it.channelId || "", videoUrl, channelUrl,
      it.viewCount || "", it.publishedAt || "", it.subscribers || "",
      it.totalViews || "", it.latestUploadDate || "", it.avgViews10 || "", it.efficiency || ""
    ].map(csvEscape).join(",");
    lines.push(row);
  }

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "yt_favorites_pro_pp_v4.csv";
  a.click();
  URL.revokeObjectURL(url);
}
// âœ… íƒ­ ì „í™˜(ì˜ìƒ/ì±„ë„)
function setActiveTab(which){
  const isVideo = (which === "video");
  $("panelVideo")?.classList.toggle("active", isVideo);
  $("panelChannel")?.classList.toggle("active", !isVideo);

  $("tabVideo")?.classList.toggle("active", isVideo);
  $("tabChannel")?.classList.toggle("active", !isVideo);
}

// âœ… í”„ë¦¬ì…‹ ì ìš©(ë“œë¡ /ë¶€ë™ì‚°/PET/í•´ì™¸ ë²„íŠ¼ì´ ì´ê±¸ í˜¸ì¶œí•¨)
async function applyPreset(key){
  const p = PRESETS?.[key];
  if (!p) return;

  // (ì˜ìƒ íƒ­ ì…ë ¥ê°’ ì±„ìš°ê¸°)
  if (p.video){
    if ($("v_q")) $("v_q").value = p.video.q ?? "";
    if ($("v_or")) $("v_or").value = p.video.or ?? "";
    if ($("v_ex")) $("v_ex").value = p.video.ex ?? "";
    if ($("v_region")) $("v_region").value = p.video.region ?? "KR";
    if ($("v_order")) $("v_order").value = p.video.order ?? "relevance";
  }

  // íƒ­ì€ ì˜ìƒìœ¼ë¡œ ì´ë™ë§Œ (ê²€ìƒ‰ ì‹¤í–‰ì€ ì§€ê¸ˆì€ ì•ˆ ê±´ë“œë¦½ë‹ˆë‹¤)
  setActiveTab("video");
}

/** ========== ì´ˆê¸°í™” ========== */
function init() {
  fillRegionSelect($("v_region"));
  fillRegionSelect($("c_region"));
  wireTables();
  wireVideoTableEvents();
  wireChannelTableEvents();
  wireSearchButtons(); // âœ… ì´ ì¤„ ì¶”ê°€

  function wireSearchButtons(){
  // âœ… ì˜ìƒ ê²€ìƒ‰ ë²„íŠ¼
  $("v_btnSearch")?.addEventListener("click", async () => {
    try{
      v.history = [];
      v.pageToken = "";
      await videoSearch("");
    }catch(e){
      alert(e.message || e);
    }
  });

  // Enterë¡œë„ ê²€ìƒ‰ë˜ê²Œ(ì˜ìƒ ê²€ìƒ‰ì–´ ì¹¸)
  $("v_q")?.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      $("v_btnSearch")?.click();
    }
  });

  // âœ… ì±„ë„ ê²€ìƒ‰ ë²„íŠ¼(ì›í•˜ë©´ ê°™ì´)
  $("c_btnSearch")?.addEventListener("click", async () => {
    try{
      c.history = [];
      c.pageToken = "";
      await channelSearch("");
    }catch(e){
      alert(e.message || e);
    }
  });
}


  $("p_drone")?.addEventListener("click", () => quickSearch("ë“œë¡ "));
  $("p_realestate")?.addEventListener("click", () => quickSearch("ë¶€ë™ì‚°"));
  $("p_pet")?.addEventListener("click", () => quickSearch("ê°•ì•„ì§€ OR ê³ ì–‘ì´ OR ë°˜ë ¤ë™ë¬¼"));
  $("p_global")?.addEventListener("click", () => quickSearch("global trending"));
  $("tabVideo").addEventListener("click", () => setActiveTab("video"));
  $("tabChannel").addEventListener("click", () => setActiveTab("channel"));
  
  $("p_drone").addEventListener("click", () => applyPreset("drone"));
  $("p_realestate").addEventListener("click", () => applyPreset("realestate"));
  $("p_pet").addEventListener("click", () => applyPreset("pet"));
  $("p_global").addEventListener("click", () => applyPreset("global"));

  $("v_btnSearch").addEventListener("click", async () => {
    try { v.history = []; v.pageToken = ""; await videoSearch({ pageToken: "" }); }
    catch(e){ alert(e.message); setStatus(v.status, "ì‹¤íŒ¨"); }
  });
  $("v_btnNext").addEventListener("click", async () => { try { await videoNext(); } catch(e){ alert(e.message);} });
  $("v_btnPrev").addEventListener("click", async () => { try { await videoPrev(); } catch(e){ alert(e.message);} });
  $("v_sortLocal").addEventListener("change", applyVideoLocalSort);
  $("v_btnCsv").addEventListener("click", exportVideoCsv);
  $("v_applyFilters").addEventListener("click", applyVideoLocalSort);

  $("c_btnSearch").addEventListener("click", async () => {
    try { c.history = []; c.pageToken = ""; await channelSearch({ pageToken: "" }); }
    catch(e){ alert(e.message); setStatus(c.status, "ì‹¤íŒ¨"); }
  });
  $("c_btnCsv").addEventListener("click", exportChannelCsv);

  $("btnSaveSettings").addEventListener("click", saveSettings);
  $("btnLoadSettings").addEventListener("click", loadSettings);
  $("btnExportSettings").addEventListener("click", exportSettingsJSON);
  $("btnImportSettings").addEventListener("click", openImportDialog);
  $("dlgClose").addEventListener("click", closeImportDialog);
  $("dlgApply").addEventListener("click", applyImportJson);

  $("fav_export").addEventListener("click", exportFavJSON);
  $("fav_csv").addEventListener("click", exportFavCSV);
  $("fav_clear").addEventListener("click", () => {
    if (!confirm("ì¦ê²¨ì°¾ê¸°ë¥¼ ì „ì²´ ì‚­ì œí• ê¹Œìš”?")) return;
    favorites = { videos:{}, channels:{} };
    saveFav();
  });
  $("fav_search").addEventListener("input", renderFav);
  $("fav_sort").addEventListener("change", renderFav);
  $("fav_folder").addEventListener("change", renderFav);
  $("fav_refresh").addEventListener("click", () => refreshAllFavChannels().catch(err => alert(err.message)));

  analyzer.setLoading("ì±„ë„ì„ í´ë¦­í•˜ë©´ ìë™ ë¶„ì„ë©ë‹ˆë‹¤.");

  setStatus($("v_status"), "ì¤€ë¹„ë¨");
  setStatus($("c_status"), "ì¤€ë¹„ë¨");

  const raw = localStorage.getItem(SETTINGS_KEY);
  if (raw) { try { applySettings(JSON.parse(raw)); } catch(_){} }

  loadFav();
}
function bindSearchUI(){
  // âœ… ê²€ìƒ‰ ë²„íŠ¼(ì˜ìƒ)
  const vb = document.getElementById("v_btnSearch");
  if (vb) vb.onclick = async () => {
    v.history = [];
    v.pageToken = "";
    await videoSearch({ pageToken: "" });
  };

  // âœ… ê²€ìƒ‰ ë²„íŠ¼(ì±„ë„)
  const cb = document.getElementById("c_btnSearch");
  if (cb) cb.onclick = async () => {
    c.history = [];
    c.pageToken = "";
    await channelSearch({ pageToken: "" });
  };

  // âœ… ì—”í„°í‚¤(ì˜ìƒ/ì±„ë„)
  const vq = document.getElementById("v_q");
  if (vq) vq.addEventListener("keydown", (e) => {
    if (e.key === "Enter") vb && vb.click();
  });

  const cq = document.getElementById("c_q");
  if (cq) cq.addEventListener("keydown", (e) => {
    if (e.key === "Enter") cb && cb.click();
  });
}

init();

</script>
</body>
</html>
